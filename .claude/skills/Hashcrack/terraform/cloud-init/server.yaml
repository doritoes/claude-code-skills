#cloud-config
# Hashtopolis Server - Cloud-Init Configuration
# Ubuntu Server 24.04 LTS

hostname: ${hostname}
fqdn: ${hostname}.local
manage_etc_hosts: true

# Create user with SSH access
users:
  - name: ${ssh_user}
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${ssh_public_key}

# Update and install packages
package_update: true
package_upgrade: true

packages:
  - qemu-guest-agent
  - docker.io
  - docker-compose-v2
  - curl
  - git
  - htop
  - vim
  - net-tools
  - python3
  - python3-pip
  - jq

# Write configuration files
write_files:
  # Docker Compose for Hashtopolis
  - path: /opt/hashtopolis/docker-compose.yml
    permissions: '0644'
    content: |
      version: '3.8'

      services:
        db:
          image: mariadb:10.11
          container_name: hashtopolis-db
          environment:
            MYSQL_ROOT_PASSWORD: ${db_password}
            MYSQL_DATABASE: hashtopolis
            MYSQL_USER: hashtopolis
            MYSQL_PASSWORD: ${db_password}
          volumes:
            - db_data:/var/lib/mysql
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
            interval: 10s
            timeout: 5s
            retries: 5

        backend:
          image: hashtopolis/backend:latest
          container_name: hashtopolis-backend
          environment:
            HASHTOPOLIS_DB_HOST: db
            HASHTOPOLIS_DB_USER: hashtopolis
            HASHTOPOLIS_DB_PASS: ${db_password}
            HASHTOPOLIS_DB_DATABASE: hashtopolis
            HASHTOPOLIS_ADMIN_USER: ${admin_user}
            HASHTOPOLIS_ADMIN_PASSWORD: ${admin_password}
            HASHTOPOLIS_APIV2_ENABLE: 0
          ports:
            - "8080:80"
          volumes:
            - files:/var/www/hashtopolis/files
            - import:/var/www/hashtopolis/import
            - log:/var/www/hashtopolis/log
          depends_on:
            db:
              condition: service_healthy
          restart: unless-stopped

        frontend:
          image: hashtopolis/frontend:latest
          container_name: hashtopolis-frontend
          environment:
            HASHTOPOLIS_BACKEND_URL: http://backend
          ports:
            - "4200:80"
          depends_on:
            - backend
          restart: unless-stopped

      volumes:
        db_data:
        files:
        import:
        log:

  # Initial configuration script
  - path: /opt/hashtopolis/setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "=== Hashtopolis Server Setup ==="

      # Wait for Hashtopolis to be ready
      echo "Waiting for Hashtopolis to start..."
      for i in {1..60}; do
        if curl -sf http://localhost:8080 > /dev/null 2>&1; then
          echo "Hashtopolis is ready!"
          break
        fi
        echo "Attempt $i/60 - waiting..."
        sleep 10
      done

      # Create initial voucher for workers
      echo "Server ready. Voucher code: ${voucher_code}"

      # Save credentials to file for retrieval
      cat > /opt/hashtopolis/credentials.json << 'CREDS'
      {
        "url": "https://$(hostname -I | awk '{print $1}'):8080",
        "admin_user": "${admin_user}",
        "admin_password": "${admin_password}",
        "voucher_code": "${voucher_code}",
        "db_password": "${db_password}"
      }
      CREDS

      chmod 600 /opt/hashtopolis/credentials.json

      echo "=== Setup Complete ==="

  # Systemd service for auto-start
  - path: /etc/systemd/system/hashtopolis.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Hashtopolis Docker Compose
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/hashtopolis
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down

      [Install]
      WantedBy=multi-user.target

# Run commands after boot
runcmd:
  # Start qemu-guest-agent early for Proxmox IP reporting
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent

  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker

  # Wait for Docker to be ready
  - sleep 10

  # Create hashtopolis directory
  - mkdir -p /opt/hashtopolis

  # Start Hashtopolis
  - cd /opt/hashtopolis && docker compose pull
  - cd /opt/hashtopolis && docker compose up -d

  # Enable auto-start
  - systemctl daemon-reload
  - systemctl enable hashtopolis.service

  # Run setup script
  - /opt/hashtopolis/setup.sh

  # Signal completion
  - touch /var/run/cloud-init-complete

final_message: |
  Hashtopolis server provisioning complete!

  Server URL: https://$${hostname}:8080
  Admin User: ${admin_user}
  Voucher: ${voucher_code}

  Cloud-init completed at $TIMESTAMP
